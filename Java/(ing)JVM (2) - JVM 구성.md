# (ing)JVM (2) - JVM 구성

## JVM 구성요소

### 1) 클래스 로더

- 클래스 파일을 로드하고, **링크**를 통해 배치하는 작업을 수행하는 모듈
- 런타임 시, 동적으로 클래스를 로드하고 jar파일 내 저장된 클래스들을 JVM 위에 탑재
- 클래스를 처음으로 참조할 때, 해당 클래스를 로드하고 링크하는 역할
- `Loading` : 동적으로 필요할 때 클래스 정보(FQCN)를 통해 해당 클래스 파일을 찾고, 바이트 코드로 읽어서 메모리에 로딩
    - 클래스를 동적으로 메모리에 로딩 (= 클래스 파일을 런타임 데이터 영역에 적재)
    - 동적으로 로딩하는 이유
        - 클래스를 전부 로딩하지 않고, 필요한 시점(실제 실행되었을 시점)이 되었을 때가 되어서야 메모리에 로딩된다.
- `Linking` : 클래스 파일 검사(자바 규칙을 따르는지 검증. 현재 클래스가 참조하는 다른 클래스 로딩) 및 static 변수를 기본값인 0으로 저장
- `Initialization` : static변수를 초기값을 저장, static block 실행 등 모든 정적 변수 할당

### 2) 실행 엔진

- 클래스를 실행시키는 역할
- 클래스 로더가 JVM 내 런타임 영역에 바이트 코드를 배치 시키고, 실행 엔진에 의해 실행된다
- 실행엔진은 바이트 코드를 실제로 JVM내부에서 기계가 실행할 수 있는 형태로 변경함
- `Interpreter`
    - 실행엔진은 자바 바이트 코드를 명령어 단위로 읽어서 실행
    - 하지만 한 줄씩(기계어로 바꿔서?) 수행하기 때문에 느림
- `[JIT(Just-In-Time)](https://www.notion.so/ing-JVM-1-JVM-Compile-d8d51706c1c54923933f363da86c7a30)`
    - `Interpreter` 방식으로 실행하다가 적절한 시점에 바이트 코드 전체를 컴파일하여 기계어로 변경
    → 이후는 더 이상 인터프리팅 하지 않고 기계어로 직접 실행
- `GC(Garbage Collector)`
    - 더이상 사용되지 않는 인스턴스를 찾아 메모리에서 삭제

### 3) Runtime Data Area
- 프로그램을 수행하기 위해 OS에서 할당받은 메모리 공간
- JVM이 Java Bytecode(.class)를 실행하기 위해 사용하는 메모리 공간
- method area + heap + (java stacks + pc register + native method stacks)
    - () → thread마다 존재
- **`method area`**, **`heap`** : 모든 스레드가 공유하는 메모리
    - `method area` : 클래스 로더가 클래스 파일을 읽어오면, 클래스 정보를 파싱해서 저장.
        - 변수, 메서드, 정적 변수는 어떤게 있는지 저장
    - `heap` : 프로그램을 실행 후 생성된 모든 객체 인스턴스 및 배열 저장
- **`PC register`**, **`Java stacks`**, **`native method stacks`** : 각 스레드마다 존재하는 메모리 공간
    - `PC` : 각 thread는 method를 실행하고 있고, PC는 그 method 안에서 몇 번째 줄을 실행해야 하는지 나타내는 역할
        - Thread가 어떤 부분을 어떤 명령으로 실행해야할 지에 대한 정보를 기록하는 부분
        - 현재 수행 중인 JVM명령의 주소를 갖음
    - `Java stacks` : method가 호출될 때마다 Stack Frame 생성 스택에 push됨.
        - 이전 스택 프레임에 대한 정보, 현재 메서드가 속한 클래스, 객체에 대한 참조 등의 정보를 갖음
    - `native method stacks` : Java가 아닌 C나 C++로 작성된 코드를 실행해야 하는 경우가 있는데 이 경우 해당 메모리 사용
- **`Thread`**
    - **프로세스** 내에서 실제로 작업을 수행하는 주체. 모든 프로세스는 한 개 이상의 스레드가 존재.
        - 프로세스 : 사용자가 작성한 프로그램이 운영체제에 의해 메모리 공간을 할당받아 실행중인것
        (실행 중인 프로그램)
        - 프로세스는 프로그램에 사용되는 데이터, 메모리 등의 자원과 스레드로 구성 됨.
    - 두 개 이상의 스레드를 가지는 프로세스 → 멀티스레드 프로세스
